
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This wiki contains information and other resources to aid with modding Risk of Rain 2.">
      
      
        <meta name="author" content="Risk of Rain 2 Modding Community">
      
      
        <link rel="canonical" href="https://risk-of-thunder.github.io/R2Wiki/Mod-Creation/C%23-Programming/Hooking/IL-Hook/">
      
      
        <link rel="prev" href="../Hooking/">
      
      
        <link rel="next" href="../On-Hook/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>IL Hook - Risk of Rain 2 Modding Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="light-blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#il-hook" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="Risk of Rain 2 Modding Wiki" class="md-header__button md-logo" aria-label="Risk of Rain 2 Modding Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Risk of Rain 2 Modding Wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              IL Hook
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="light-blue" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="light-blue" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/risk-of-thunder/R2Wiki/wiki" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    risk-of-thunder/R2Wiki
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Risk of Rain 2 Modding Wiki" class="md-nav__button md-logo" aria-label="Risk of Rain 2 Modding Wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Risk of Rain 2 Modding Wiki
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/risk-of-thunder/R2Wiki/wiki" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    risk-of-thunder/R2Wiki
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to the Risk of Rain 2 Modding Wiki!
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Mod Creation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Mod Creation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Getting-Started/First-Mod/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    First Mod
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Getting-Started/So-you-want-to-mod-Risk-of-Rain-2%3F/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    So you want to mod Risk of Rain 2?
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    IDE
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            IDE
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../IDE/Visual-Studio-Code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visual Studio Code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2_2" id="__nav_2_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Visual Studio
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            Visual Studio
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../IDE/Visual-Studio/Post-Build-Events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Post Build Events
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    C# Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            C# Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Assembly-References/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Assembly References
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Code-Analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Console-Commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Console Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Debugging-Your-Mods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging Your Mods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hooking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Hot-Reloading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hot Reloading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../IContentPackProvider/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IContentPackProvider
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../IL-Hooking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IL Hooking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Mod-Compatibility%3A-Soft-Dependency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mod Compatibility: Soft Dependency
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Reflection-Crash-Course/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reflection Crash Course
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Unity-and-MonoBehaviour/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unity and MonoBehaviour
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_13" >
        
          
          <label class="md-nav__link" for="__nav_2_3_13" id="__nav_2_3_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Game Code
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_13">
            <span class="md-nav__icon md-icon"></span>
            Game Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Game-Code/Common-Components%2C-Events-and-Methods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Components, Events and Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Game-Code/Tips-and-Tricks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tips and Tricks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_14" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_14" id="__nav_2_3_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Hooking
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_14_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_14">
            <span class="md-nav__icon md-icon"></span>
            Hooking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Hooking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    What is Hooking?
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    IL Hook
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    IL Hook
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-cil" class="md-nav__link">
    <span class="md-ellipsis">
      What is CIL?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is CIL?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-stack" class="md-nav__link">
    <span class="md-ellipsis">
      The stack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ilcursor" class="md-nav__link">
    <span class="md-ellipsis">
      ILCursor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ILCursor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pattern-matching" class="md-nav__link">
    <span class="md-ellipsis">
      Pattern matching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pattern matching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-simple-matching-and-modifying-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Example 1: Simple matching and modifying a value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-modifying-a-value-with-emitdelegate" class="md-nav__link">
    <span class="md-ellipsis">
      Example 2: Modifying a value with EmitDelegate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#robust-pattern-matching" class="md-nav__link">
    <span class="md-ellipsis">
      Robust pattern matching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Robust pattern matching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-match-as-little-as-possible-to-uniquely-identify-the-correct-cursor-index" class="md-nav__link">
    <span class="md-ellipsis">
      1. Match as little as possible to uniquely identify the correct cursor index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dynamically-match-the-index-of-a-local-variable" class="md-nav__link">
    <span class="md-ellipsis">
      2. Dynamically match the index of a local variable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-matching-snippets-of-a-pattern-with-gaps" class="md-nav__link">
    <span class="md-ellipsis">
      3. Matching snippets of a pattern with gaps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-use-cindex-with-great-care" class="md-nav__link">
    <span class="md-ellipsis">
      4. Use c.Index++ with great care
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emitting-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Emitting instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Emitting instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditionals-and-branches" class="md-nav__link">
    <span class="md-ellipsis">
      Conditionals and branches
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conditionals and branches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-put-some-code-in-an-if-block" class="md-nav__link">
    <span class="md-ellipsis">
      Example 1: Put some code in an if block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-null-check-a-statement-to-patch-nre-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Example 2: Null check a statement to patch NRE errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-add-an-else-to-an-if" class="md-nav__link">
    <span class="md-ellipsis">
      Example 3: Add an else to an if
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-chain" class="md-nav__link">
    <span class="md-ellipsis">
      Hook chain
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-il-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      Manual IL Hooks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual IL Hooks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hooking-a-coroutine-ienumerator" class="md-nav__link">
    <span class="md-ellipsis">
      Hooking a coroutine (IEnumerator)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Misc notes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../On-Hook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    On Hook
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_15" >
        
          
          <label class="md-nav__link" for="__nav_2_3_15" id="__nav_2_3_15_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Networking
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_15">
            <span class="md-nav__icon md-icon"></span>
            Networking
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Networking/MiniRpcLib/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MiniRpcLib
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Networking/R2API.NetworkingAPI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    R2API.NetworkingAPI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Networking/Server-side-and-client-side-mods/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Server side and client side mods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Networking/UNet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UNet
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Testing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Testing/Testing-Multiplayer-Alone/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Testing Multiplayer Alone
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Cookbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cookbook
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Developer Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Developer Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Addressables-Assets-Keys/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Addressables Assets Keys
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Items-and-Equipments-Data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Items and Equipments Data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Layers-and-collisions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Layers and collisions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Prefabs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prefabs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Scene-Names/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scene Names
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Sound-%E2%80%90-Wwise-Events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sound - Wwise Events
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Developer-Reference/Style-Reference-Sheet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Style Reference Sheet
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Assets
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Assets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Artifacts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Artifacts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Character/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Character
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Difficulty/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Difficulty
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Elites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating an Elite
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Extraction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Icons/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Icons
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Interactables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interactables
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Items/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Items
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Loading-Assets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loading Assets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Localization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Localization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Merging-Materials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Merging Materials
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Skills/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Skills
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Stage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Translation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Translation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/UI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Void-Items/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Void Items
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_17" >
        
          
          <label class="md-nav__link" for="__nav_2_7_17" id="__nav_2_7_17_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Items
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_17">
            <span class="md-nav__icon md-icon"></span>
            Items
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Items/Using-the-RoR2CreateItemTemplate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using the RoR2CreateItemTemplate
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_18" >
        
          
          <label class="md-nav__link" for="__nav_2_7_18" id="__nav_2_7_18_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Shaders
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_18">
            <span class="md-nav__icon md-icon"></span>
            Shaders
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Shaders/HG-Triplanar-Terrain-Blend/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HG Triplanar Terrain Blend
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Shaders/Working-Shaders-outside-of-an-AssetRipper-Project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Working Shaders outside of an AssetRipper project
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_19" >
        
          
          <label class="md-nav__link" for="__nav_2_7_19" id="__nav_2_7_19_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Skins
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_19_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_19">
            <span class="md-nav__icon md-icon"></span>
            Skins
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Skins/Creating-skin-for-vanilla-characters-with-custom-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Creating skin for vanilla characters with custom model
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_20" >
        
          
          <label class="md-nav__link" for="__nav_2_7_20" id="__nav_2_7_20_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Sounds
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_20_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_20">
            <span class="md-nav__icon md-icon"></span>
            Sounds
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_20_1" >
        
          
          <label class="md-nav__link" for="__nav_2_7_20_1" id="__nav_2_7_20_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    WWise
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_7_20_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_20_1">
            <span class="md-nav__icon md-icon"></span>
            WWise
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Sounds/WWise/Custom-Music/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Music
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Assets/Sounds/WWise/Getting-Started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Unity-Version/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unity Version
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Unity Editor Usage
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Unity Editor Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Unity-Editor-Usage/Editor-Scripts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Editor Scripts
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Unity-Editor-Usage/RoR2-Editor-Kit-Utilization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RoR2 Editor Kit Utilization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Unity-Editor-Usage/Using-MonoBehaviour-Scripts-in-Editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using MonoBehaviour Scripts in Editor
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" >
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ThunderKit
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            ThunderKit
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ThunderKit/Crash-Course-and-Getting-Started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ThunderKit - Crash course and Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ThunderKit/Upgrading-your-project-to-use-R2API%27s-Split-Assemblies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Upgrading your project to use R2API's Split Assemblies
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ThunderKit/Using-the-DOTS-framework-in-Modding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Thunderkit - Using the DOTS framework in Modding
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Updating Your Mods
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            Updating Your Mods
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/For-Survivors-of-the-Void/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    For Survivors of the Void
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/For-Seekers-of-the-Storm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    For Seekers of the Storm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/Updating-Core-API-Changelog-1.3.7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core API Changelog 1.3.7 - Seekers of the Storm 2.0 Phase 2
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/Updating-Core-API-Changelog-1.3.8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core API Changelog 1.3.8 - Seekers of the Storm 2.0 Phase 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_5" >
        
          
          <label class="md-nav__link" for="__nav_2_11_5" id="__nav_2_11_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    1.3.9 Memory Optimization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_5">
            <span class="md-nav__icon md-icon"></span>
            1.3.9 Memory Optimization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/1.3.9-Memory-Optimization/Core-API-Changelog-1.3.9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core API Changelog 1.3.9
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/1.3.9-Memory-Optimization/Updating-Guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Updating Guide
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/Updating-Core-API-Changelog-1.4.0/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core API Changelog 1.4.0 - Alloy Collective
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Updating-Your-Mods/Updating-Core-API-Changelog-1.4.1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core API Changelog 1.4.1 - Alloyed Collective Patch
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Playing
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Playing
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Playing/Getting-Started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Playing/FAQ/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FAQ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Playing/Running-modded-and-unmodded-game-with-shortcuts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running modded and unmodded game with shortcuts
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Tools
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Tools/BepInEx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BepInEx
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Tools/Glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Tools/Source-Code-Diff/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Source Code Diff
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Custom-Character-Creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Character
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../Item-%26-Equipment-IDs-and-Names/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Format
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-cil" class="md-nav__link">
    <span class="md-ellipsis">
      What is CIL?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is CIL?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-stack" class="md-nav__link">
    <span class="md-ellipsis">
      The stack
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ilcursor" class="md-nav__link">
    <span class="md-ellipsis">
      ILCursor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ILCursor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pattern-matching" class="md-nav__link">
    <span class="md-ellipsis">
      Pattern matching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pattern matching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-simple-matching-and-modifying-a-value" class="md-nav__link">
    <span class="md-ellipsis">
      Example 1: Simple matching and modifying a value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-modifying-a-value-with-emitdelegate" class="md-nav__link">
    <span class="md-ellipsis">
      Example 2: Modifying a value with EmitDelegate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#robust-pattern-matching" class="md-nav__link">
    <span class="md-ellipsis">
      Robust pattern matching
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Robust pattern matching">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-match-as-little-as-possible-to-uniquely-identify-the-correct-cursor-index" class="md-nav__link">
    <span class="md-ellipsis">
      1. Match as little as possible to uniquely identify the correct cursor index
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-dynamically-match-the-index-of-a-local-variable" class="md-nav__link">
    <span class="md-ellipsis">
      2. Dynamically match the index of a local variable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-matching-snippets-of-a-pattern-with-gaps" class="md-nav__link">
    <span class="md-ellipsis">
      3. Matching snippets of a pattern with gaps
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-use-cindex-with-great-care" class="md-nav__link">
    <span class="md-ellipsis">
      4. Use c.Index++ with great care
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emitting-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Emitting instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Emitting instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conditionals-and-branches" class="md-nav__link">
    <span class="md-ellipsis">
      Conditionals and branches
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conditionals and branches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-put-some-code-in-an-if-block" class="md-nav__link">
    <span class="md-ellipsis">
      Example 1: Put some code in an if block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-null-check-a-statement-to-patch-nre-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Example 2: Null check a statement to patch NRE errors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-add-an-else-to-an-if" class="md-nav__link">
    <span class="md-ellipsis">
      Example 3: Add an else to an if
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hook-chain" class="md-nav__link">
    <span class="md-ellipsis">
      Hook chain
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-il-hooks" class="md-nav__link">
    <span class="md-ellipsis">
      Manual IL Hooks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Manual IL Hooks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#hooking-a-coroutine-ienumerator" class="md-nav__link">
    <span class="md-ellipsis">
      Hooking a coroutine (IEnumerator)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#misc-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Misc notes
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/risk-of-thunder/R2Wiki/wiki/Mod-Creation_C%23-Programming_Hooking_IL-Hook/_edit" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="il-hook">IL Hook</h1>
<p>IL Hooks can modify the set of instructions a method consists of in this form, thus allowing one to manipulate the method logic in ways that are not possible with <a href="https://risk-of-thunder.github.io/R2Wiki/Mod-Creation/C%23-Programming/Hooking/On-Hook">On Hooks</a>.</p>
<h2 id="what-is-cil">What is CIL?</h2>
<p><a href="https://en.m.wikipedia.org/wiki/Common_Intermediate_Language">CIL</a> is the result of compiling readable C# code into another form, which can be universally processed by multiple architectures and converted into machine code targeting the current architecture at runtime, hence "intermediate language".</p>
<h3 id="the-stack">The stack</h3>
<p>A Stack is used at a low/intermediate level to process data. As explained by Wikipedia, only the value at the very top of the stack can be popped from the stack. Given a list of IL instructions, the processor will iterate its way through the operations, emitting values to the stack, and executing operations upon the stack as and when the instruction is executed. At the point of termination (return), the stack must be empty, with no more instructions or values remaining. If this is not the case, the stack is said to be unbalanced and the process will terminate with the error Invalid ILCode.</p>
<p>To see how the transformation from C# code to CIL affects the order of instructions due to how the stack operates, we can use a simple example.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="nf">ComputeFormula</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">}</span>
</code></pre></div>
<p>The equivalent CIL would be</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>ldc.i4.2 // pushes the int32(2) onto the stack
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>ldc.i4.1 // pushes the int32(1) onto the stack
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>ldarg.0  // pushes the value of the first argument onto the stack
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>add
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>mul
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>ret      // method returns
</code></pre></div>
<p>For the sake of argument let's also assume that <code>x = 3</code>. After the first 3 instructions from bottom to top the stack contains [2,1,3]. When the <code>add</code> operation is executed, the top two values are popped from the stack, added together to produce [4], which is then pushed onto the stack resulting in [2,4]. Next, the <code>mul</code> operation pops both of these values, multiplies them together and the resulting stack contains only [8]. The method then returns, passing the value 8 to the calling method. The method has finished executing, there are no more operations and the stack is now empty, thus the stack is balanced.</p>
<p><a href="https://download.microsoft.com/download/7/3/3/733ad403-90b2-4064-a81e-01035a7fe13c/ms%20partition%20iii.pdf">ECMA-335, Partition III (Section 3)</a> contains information about each OpCode, e.g., how many parameters each one pops from the stack, the ordering of the values, and the return type of the operation.</p>
<h2 id="ilcursor">ILCursor</h2>
<p>The <code>ILCursor</code> is an implementation by MonoMod to facilitate traversal of the stack in a user friendly manner. Its documentation can be found <a href="https://monomod.dev/api/MonoMod.Cil.ILCursor.html">here</a>.</p>
<p>The following references are widely used when working with it:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">Mono.Cecil.Cil</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">MonoMod.Cil</span><span class="p">;</span>
</code></pre></div>
<p>To apply an IL Hook we use similar syntax to how one subscribes and unsubscribes from events in C#, even though hooks are very different from events.</p>
<p>Using the <code>IL</code> namespace fully qualify the method you want to hook, then type <code>+=</code> and then press <code>Tab</code> to autocomplete the hook delegate with the correct signature. For example,</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">IL</span><span class="p">.</span><span class="n">RoR2</span><span class="p">.</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">TakeDamageProcess</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="c1">//press Tab now</span>
</code></pre></div>
<p>To undo this hook, use <code>-=</code> instead of <code>+=</code>.</p>
<p>The cursor is created from the argument provided by the hook delegate.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">SomeILHook</span><span class="p">(</span><span class="n">ILContext</span><span class="w"> </span><span class="n">il</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="n">ILCursor</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ILCursor</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="p">}</span>
</code></pre></div>
<p>From it one can access the list of all IL instructions with <code>c.Instrs</code>, while <code>c.Index</code> gives the current position of the cursor. Similar to a text cursor the position of ILCursor is between instructions and <code>c.Prev</code> / <code>c.Next</code> access the respective one on either side.</p>
<p><code>Debug.Log(c)</code> prints the previous and next instructions while <code>Debug.Log(il)</code> prints all the instructions of the hooked method. The latter can be useful at runtime to inspect whether any instructions have already been modified from an earlier hook compared to what one sees from the decompiled assembly. If you want to see the result of your emitted instructions, the following may be more desirable</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1">// The offsets of your emitted instructions are normally recalculated after the hook</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1">// has been applied and until then are displayed as IL_0000. While this can make it</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="c1">// easier to spot if your instructions have been emitted in the right place, it makes</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1">// it harder to verify when branches are involved. Force this recalculation now.</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">il</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">RecalculateILOffsets</span><span class="p">();</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
</code></pre></div>
<p>The main functionality of the cursor revolves around moving it to the right location (pattern matching) and modifying or emitting any new instructions. The following sections deal with any subtleties in both of these aspects.</p>
<p>It is important to note that while <code>c.Remove()</code> and <code>c.RemoveRange()</code> are available resources to remove instructions, they should be avoided as much as possible because another instruction could be referencing a removed one, leading to issues. If you want to replace an instruction, do so from <code>c.Prev</code> / <code>c.Next</code> directly, while for skipping a range of instructions use <a href="./#conditionals-and-branches"><code>Br</code></a>.</p>
<h3 id="pattern-matching">Pattern matching</h3>
<p>Using <code>c.Index</code> to directly go to the desired location in a set of IL instructions is a bad idea, since if another mod or another game update modifies any instruction prior to this, we will end up at the wrong place and any instruction manipulation will break the game. Instead, we match a certain set of instructions that mark out desired location and we let the cursor dynamically decide where that is, if it exists.</p>
<p>To that end we use <code>c.TryGotoNext()</code> and <code>c.TryGotoPrev()</code>, which return a bool if a match is successful while also updating the <code>Index</code> accordingly. The <code>GotoNext()</code> and <code>GotoPrev()</code> versions should be avoided since they raise a <code>KeyNotFoundException</code> error if a match has failed, which can abruptly interrupt your mod's initialization process.</p>
<p>When we match a block of instructions, the cursor is placed before the first matched instruction by default. If you want the cursor to be after the last matched instruction instead, you can pass <code>MoveType.After</code> as the first argument to the TryGoto search.</p>
<p>When matching instructions the pattern is a method call with the <code>Match</code> prefix and the name of the OpCode, e.g., <code>x.MatchLdarg()</code>, <code>x.MatchLdstr()</code>, etc. The majority of these take an argument to indicate the value related to this instruction. For example, <code>x.MatchLdstr("Hello")</code> matches loading the string "Hello" on the stack. On the other hand, <code>x.MatchLdstr(out string s)</code> matches a <code>ldstr</code> instruction regardless of its value which is also returned to the user so it can be referenced again later. This can be useful for caching a certain local variable or conditional jump target.</p>
<p>For invoking methods and accessing fields the argument/out value is a MethodInfo/FieldInfo, which can be obtained with reflection. However, there is another approach which can be less verbose:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">x</span><span class="p">.</span><span class="n">MatchLdfld</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">).</span><span class="n">GetField</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">.</span><span class="n">bodyIndex</span><span class="p">)));</span><span class="w"> </span><span class="c1">// reflection</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">x</span><span class="p">.</span><span class="n">MatchLdfld</span><span class="o">&lt;</span><span class="n">CharacterBody</span><span class="o">&gt;</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">.</span><span class="n">bodyIndex</span><span class="p">));</span><span class="w">                  </span><span class="c1">// generic</span>
</code></pre></div>
<p>Furthermore, for methods there is both <code>x.MatchCall</code> and <code>x.MatchCallvirt</code> which are used in different scenarios, but it is recommended to use <code>x.MatchCallOrCallvirt</code> instead so you don't have to worry about using the correct one.</p>
<h4 id="example-1-simple-matching-and-modifying-a-value">Example 1: Simple matching and modifying a value</h4>
<p>Let's say we want to modify the Crowbar health threshold from 90% to 80%. This functionality is found in <code>HealthComponent.TakeDamageProcess</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">num</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">fullCombinedHealth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.9f</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">itemCount2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">characterMaster</span><span class="p">.</span><span class="n">inventory</span><span class="p">.</span><span class="n">GetItemCount</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Crowbar</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">itemCount2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">        </span><span class="n">num4</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">1f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.75f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">itemCount2</span><span class="p">;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">        </span><span class="n">EffectManager</span><span class="p">.</span><span class="n">SimpleImpactEffect</span><span class="p">(</span><span class="n">AssetReferences</span><span class="p">.</span><span class="n">crowbarImpactEffectPrefab</span><span class="p">,</span><span class="w"> </span><span class="n">damageInfo</span><span class="p">.</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">damageInfo</span><span class="p">.</span><span class="n">force</span><span class="p">,</span><span class="w"> </span><span class="n">transmit</span><span class="p">:</span><span class="w"> </span><span class="k">true</span><span class="p">);</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="p">}</span>
</code></pre></div>
<p>With ILSpy from the top bar we can select to view "IL with C#", while with dnSpy we can right click on <code>num &gt;= fullCombinedHealth * 0.9f</code> and select "Edit IL instructions..." so we can see the instructions this corresponds to.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>IL_085a: ldloc.s 4
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>IL_085c: ldarg.0
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>IL_085d: call instance float32 RoR2.HealthComponent::get_fullCombinedHealth()
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>IL_0862: ldc.r4 0.9
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>IL_0867: mul
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>IL_0868: blt.un.s IL_08bb
</code></pre></div>
<p>With this information our hook can then be</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Awake</span><span class="p">()</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="n">IL</span><span class="p">.</span><span class="n">RoR2</span><span class="p">.</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">TakeDamageProcess</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">ModifyCrowbarThreshold</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="p">}</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ModifyCrowbarThreshold</span><span class="p">(</span><span class="n">ILContext</span><span class="w"> </span><span class="n">il</span><span class="p">)</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">    </span><span class="n">ILCursor</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ILCursor</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="n">MoveType</span><span class="p">.</span><span class="n">After</span><span class="p">,</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdloc</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdarg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="p">(</span><span class="n">AccessTools</span><span class="p">.</span><span class="n">PropertyGetter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">fullCombinedHealth</span><span class="p">))),</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdcR4</span><span class="p">(</span><span class="mf">0.9f</span><span class="p">)))</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">        </span><span class="c1">// Successful match and the cursor is now between &quot;ldc.r4 0.9&quot; and &quot;mul&quot;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="c1">// `c.Prev.OpCode` returns &quot;ldc.r4&quot; - you rarely want to modify this</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">        </span><span class="c1">// `c.Prev.Operand` returns the value of the opcode, if any</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">        </span><span class="n">c</span><span class="p">.</span><span class="n">Prev</span><span class="p">.</span><span class="n">Operand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.8f</span><span class="p">;</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="n">Logger</span><span class="p">.</span><span class="n">LogError</span><span class="p">(</span><span class="n">il</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">Name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; IL Hook failed!&quot;</span><span class="p">);</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="p">}</span>
</code></pre></div>
<h4 id="example-2-modifying-a-value-with-emitdelegate">Example 2: Modifying a value with EmitDelegate</h4>
<p>Sometimes the value we want to replace in an instruction can vary during runtime or the logic we need requires emiting very complex instructions, such as branching and multiple operations. In such a case, we place our cursor after the value we want to replace and emit a delegate which consumes this value and returns a similar one of the same type. The best part is that the code in the delegate is written in plain C#.</p>
<p>Using the same example as before, our hook with the EmitDelegate approach becomes</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">private</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">ModifyCrowbarThreshold</span><span class="p">(</span><span class="n">ILContext</span><span class="w"> </span><span class="n">il</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="c1">// The same pattern matching as before that puts the cursor between &quot;ldc.r4 0.9&quot; and &quot;mul&quot;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="c1">// - The float value 0.9 is at the top of the stack, which we will consume</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="c1">// - For our logic we also need the attacker which can be obtained from the DamageInfo argument</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="c1">// - The value we return from our delegate must also be a float so we don&#39;t disrupt stack</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_1</span><span class="p">);</span><span class="w"> </span><span class="c1">// Load the DamageInfo argument (Ldarg_0 is `this` since this is an instance method)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">EmitDelegate</span><span class="o">&lt;</span><span class="n">Func</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="n">DamageInfo</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="p">((</span><span class="n">threshold</span><span class="p">,</span><span class="w"> </span><span class="n">damageInfo</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">        </span><span class="c1">// We don&#39;t need to null check this because it&#39;s guaranteed to have a valid value by the time the relevant code has been reached</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">damageInfo</span><span class="p">.</span><span class="n">attacker</span><span class="p">.</span><span class="n">GetComponent</span><span class="o">&lt;</span><span class="n">CharacterBody</span><span class="o">&gt;</span><span class="p">().</span><span class="n">inventory</span><span class="p">.</span><span class="n">GetItemCount</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Crowbar</span><span class="p">);</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bars</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">1f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">((</span><span class="mf">1f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1f</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">_crowbarScalar</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">bars</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1f</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_crowbarCap</span><span class="p">);</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">threshold</span><span class="p">;</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="p">}</span>
</code></pre></div>
<p>Delegates can either return a value, as defined by Func<T>, or they can return void, defined by Action<T>. In the case of Func<T> the last type defined is the return type.</p>
<p>According to <a href="https://discordapp.com/channels/562704639141740588/562704639569428506/604753431894294528">jade</a>:</p>
<blockquote>
<p>EmitDelegate was designed to behave the same as <code>call</code> / <code>callvirt</code>, thus passing all args from stack onto the delegate just like if it was a normal method call
thus, if you push A, B, C, your delegate should accept A, B, C in that order. It doesn't pop one by one, it "pops" the last N elements from the stack at once.</p>
</blockquote>
<p>Action/Func don't support ref parameters so if the method you want to invoke includes one, define an actual method and then use it directly with <code>c.EmitDelegate(MyMethod)</code>.</p>
<h4 id="robust-pattern-matching">Robust pattern matching</h4>
<p>You should not rely on the instructions you see when you decompile the game to be the same as those when modifying a method at runtime. This can be particularly true for frequently hooked methods, such as <code>CharacterBody.RecalculateStats</code>, <code>HealthComponent.TakeDamageProcess</code>, and <code>GlobalEventManager.ProcessHitEnemy</code>. But also hardcoding certain values can break a hook when the game updates.</p>
<p>The following tips establish good practices to ensure the pattern matching is as dynamic as possible while failure due to mod conflicts are minimized.</p>
<h5 id="1-match-as-little-as-possible-to-uniquely-identify-the-correct-cursor-index">1. Match as little as possible to uniquely identify the correct cursor index</h5>
<p>The more instructions that are included in your match, the more likely it is to hit a point where another mod has inserted their own instructions. For example, if you want to replace the value of a method call, just matching the call instruction should suffice. Assuming of course it does not occur multiple times in the hooked method.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="n">MoveType</span><span class="p">.</span><span class="n">After</span><span class="p">,</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="o">&lt;</span><span class="n">Type</span><span class="o">&gt;</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="n">MethodName</span><span class="p">)))</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="p">{</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="c1">// Match found, EmitDelegate can be used now to modify its return value.</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="p">}</span>
</code></pre></div>
<p>For long methods that may repeat the same pattern multiple times, you can use a "landmark" to first get the cursor index near your target pattern and then search for your pattern directly. For example, let's say we want to modify the success roll for Sticky Bomb in <code>ProcessHitEnemy</code>. <code>Util.CheckRoll</code> is used multiple times in that method, but we can narrow it down like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// The code where Sticky Bomb rolls for proc:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="c1">// int itemCount10 = inventory.GetItemCount(RoR2Content.Items.StickyBomb);</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1">// if (itemCount10 &gt; 0 &amp;&amp; Util.CheckRoll(5f * (float)itemCount10 * damageInfo.procCoefficient, master) &amp;&amp; (bool)characterBody2)</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdsfld</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">StickyBomb</span><span class="p">)))</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="n">MoveType</span><span class="p">.</span><span class="n">After</span><span class="p">,</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">Util</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">Util</span><span class="p">.</span><span class="n">CheckRoll</span><span class="p">))))</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="p">{</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="c1">// success</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="p">}</span>
</code></pre></div>
<h5 id="2-dynamically-match-the-index-of-a-local-variable">2. Dynamically match the index of a local variable</h5>
<p>In a <a href="./#example-1-simple-matching-and-modifying-a-value">previous example</a> where we matched the formula for the Crowbar threshold, we hardcoded which local variable to load. This variable is assigned earlier in the method</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>// float num = combinedHealth;
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>IL_0035: ldarg.0
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>IL_0036: call instance float32 RoR2.HealthComponent::get_combinedHealth()
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>IL_003b: stloc.s 4
</code></pre></div>
<p>It is possible one day for new code to be added before that part, effectively shifting this variable index to 5 or greater. However, we can ensure we always have the right index by caching where that value is stored during the related <code>stloc</code> instruction.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">combinedHealthVarIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdarg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="p">(</span><span class="n">AccessTools</span><span class="p">.</span><span class="n">PropertyGetter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">combinedHealth</span><span class="p">))),</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchStloc</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">combinedHealthVarIndex</span><span class="p">)))</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="p">{</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">    </span><span class="c1">// Now when we match the Crowbar formula, we can do</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="c1">// x =&gt; x.MatchLdloc(combinedHealthVarIndex)</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="p">}</span>
</code></pre></div>
<h5 id="3-matching-snippets-of-a-pattern-with-gaps">3. Matching snippets of a pattern with gaps</h5>
<p>Let's say that in <code>EntityStates.GenericCharacterMain.ProcessJump(bool)</code> we want to cache the local variable index for the number of Wax Quail stacks.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>// int itemCount = base.characterBody.inventory.GetItemCount(RoR2Content.Items.JumpBoost);
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>IL_004b: ldarg.0
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>IL_004c: call instance class RoR2.CharacterBody EntityStates.EntityState::get_characterBody()
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>IL_0051: callvirt instance class RoR2.Inventory RoR2.CharacterBody::get_inventory()
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>IL_0056: ldsfld class RoR2.ItemDef RoR2.RoR2Content/Items::JumpBoost
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>IL_005b: callvirt instance int32 RoR2.Inventory::GetItemCount(class RoR2.ItemDef)
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>IL_0060: stloc.3
</code></pre></div>
<p>It would make sense to match the last 3 instructions, but it is possible for another mod to have already injected their own code after the GetItemCount call to also add the number of stacks of their modded item. While it may feel pedantic, it would be safer to just match the <code>ldsfld</code> and <code>stloc</code> instructions in cascading checks which does not care what else happens in the between.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">waxQuailVarIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdsfld</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">JumpBoost</span><span class="p">)))</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchStloc</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">waxQuailVarIndex</span><span class="p">)))</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">{</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="c1">// success</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="p">}</span>
</code></pre></div>
<h5 id="4-use-cindex-with-great-care">4. Use c.Index++ with great care</h5>
<p>This follows from the previous example but it deserves its own section for added stress. It may seem convenient to match a short pattern and then manually move the cursor to also manipulate another nearby section, but <strong>do not use <code>c.Index++</code> / <code>c.Index--</code> outside of matched blocks</strong>. Doing so is considered undefined behavior because you cannot guarantee where a mod has injected new instructions.</p>
<p>Manually moving the cursor <strong>within</strong> a matched block is, however, absolutely fine. Here is an example in <code>MinionLeashBodyBehavior.OnDisable</code> where the need for this arises.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>if (SceneInfo.instance.sceneDef.cachedName == &quot;meridian&quot;)
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>IL_0000: call class RoR2.SceneInfo RoR2.SceneInfo::get_instance()
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>IL_0005: callvirt instance class RoR2.SceneDef RoR2.SceneInfo::get_sceneDef()
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>IL_000a: callvirt instance string RoR2.SceneDef::get_cachedName()
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>IL_000f: ldstr &quot;meridian&quot;
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>IL_0014: call bool [netstandard]System.String::op_Equality(string, string)
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>IL_0019: brfalse.s IL_002c
</code></pre></div>
<p>Here we want to fix runtime NRE errors in the above line by changing it to <code>SceneInfo.instance?.sceneDef?.cachedName</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">ILLabel</span><span class="w"> </span><span class="n">falseBranch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">null</span><span class="p">;</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="c1">// Matching such a long block allows us to put the cursor at the beginning</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1">// of our instruction block while</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1">// - ensuring that `SceneInfo.instance.sceneDef` exists, and</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="c1">// - caching the brfalse target at the end which we need to use</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="p">(</span><span class="n">AccessTools</span><span class="p">.</span><span class="n">PropertyGetter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">SceneInfo</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">SceneInfo</span><span class="p">.</span><span class="n">instance</span><span class="p">))),</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="p">(</span><span class="n">AccessTools</span><span class="p">.</span><span class="n">PropertyGetter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">SceneInfo</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">SceneInfo</span><span class="p">.</span><span class="n">sceneDef</span><span class="p">))),</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="p">(</span><span class="n">AccessTools</span><span class="p">.</span><span class="n">PropertyGetter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">SceneDef</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">SceneDef</span><span class="p">.</span><span class="n">cachedName</span><span class="p">))),</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdstr</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">_</span><span class="p">),</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;op_Equality&quot;</span><span class="p">),</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchBrfalse</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">falseBranch</span><span class="p">)))</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="p">{</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w">    </span><span class="c1">// This puts the cursor after `SceneInfo.instance` has been loaded.</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">    </span><span class="c1">// We already know what this instruction is so there are no surprises.</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Index</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w">    </span><span class="c1">// Now emit the following instructions to null check this value</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w">    </span><span class="c1">// and skip the conditional block with the cached brfalse target.</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Dup</span><span class="p">);</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">UnityEngine</span><span class="p">.</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Call</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;op_Implicit&quot;</span><span class="p">);</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Brtrue</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Next</span><span class="p">);</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Pop</span><span class="p">);</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Br</span><span class="p">,</span><span class="w"> </span><span class="n">falseBranch</span><span class="p">);</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w">    </span><span class="c1">// As we emit instructions in front of the cursor, the</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w">    </span><span class="c1">// cursor also moves in front of the emitted instruction</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w">    </span><span class="c1">// just like a text cursor leaves behind a typed letter.</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w">    </span><span class="c1">// We are still after `SceneInfo.instance` and by advancing</span>
<a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w">    </span><span class="c1">// the cursor one more to the right, we will be after the</span>
<a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w">    </span><span class="c1">// `SceneInfo.instance.sceneDef` value has been loaded to</span>
<a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="w">    </span><span class="c1">// the stack. We then repeat the same process to null check</span>
<a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="w">    </span><span class="c1">// it as well. In fact, the previous logic could be put in</span>
<a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="w">    </span><span class="c1">// a for loop to avoid duplicating code.</span>
<a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="p">}</span>
</code></pre></div>
<h3 id="emitting-instructions">Emitting instructions</h3>
<p><strong>Constants</strong></p>
<p><code>Ldc_I4</code>, <code>Ldc_R4</code>, and <code>Ldstr</code> can be used to push integers, floats, and strings to the stack respectively. For example <code>c.Emit(OpCodes.Ldc_I4, 10);</code></p>
<p>Booleans are treated as integers with the values 0 and 1.</p>
<p><strong>Arguments</strong></p>
<p>Methods are called with 0+ arguments. They are 0-indexed, so the first argument is <code>Ldarg_0</code>, the second <code>Ldarg_1</code>, etc. If the method is an instance method, the first argument is the instance. For example, for <code>HealthComponent.TakeDamageProcess(DamageInfo damageInfo)</code>, <code>Ldarg_0</code> is <code>this</code> and <code>Ldarg_1</code> is <code>damageInfo</code>. To load an argument on the stack</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="c1">// Ldarg_0 to Ldarg_3 are provided for convenience, for higher values use</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
</code></pre></div>
<p><strong>Fields</strong></p>
<p>A class instance field can be loaded on the stack with <code>Ldfld</code> as long as the class instance is already at the top of the stack.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">// Assuming we&#39;re in TakeDamageProcess</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">HealthComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldfld</span><span class="p">,</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">body</span><span class="p">));</span>
</code></pre></div>
<p>To store a value to an instance field, from the bottom to the top of the stack we need the class instance and the value we want to store.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">// Still in TakeDamageProcess</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">Ldc_R4</span><span class="p">,</span><span class="w"> </span><span class="mf">100f</span><span class="p">);</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">HealthComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Stfld</span><span class="p">,</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">health</span><span class="p">));</span>
</code></pre></div>
<p>The equivalent for static fields <code>Ldsfld</code> and <code>Stsfld</code>. Note that if you want to access a static subtype, <code>c.Emit&lt;Type.Subtype&gt;()</code> is not allowed and you have to resort to <code>c.Emit(typeof(Type.Subtype))</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1">// Loading `RoR2Content.Items.Hoof`</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldsfld</span><span class="p">,</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Items</span><span class="p">.</span><span class="n">Hoof</span><span class="p">));</span>
</code></pre></div>
<p><strong>Local variables</strong></p>
<p>Loading and storing to local variables can be done with <code>Ldloc</code> and <code>Stloc</code>. For the latter the value you want to store needs to be at the top of the stack.</p>
<p>Local variables are identified by a 0-based index, e.g., <code>c.Emit(OpCodes.Ldloc, 5)</code>. Similar to loading arguments, <code>Ldloc_0</code> to <code>Ldloc_3</code> and the respective for <code>Stloc</code> are provided for convenience.</p>
<p>Hardcoding the variable index can lead to errors if the code is ever updated so it is advised to use <a href="./#2-dynamically-match-the-index-of-a-local-variable">dynamic local variable indexing</a> instead for future-proofing.</p>
<p>It is also possible to create your own local variables with the following code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1">// A new local variable of type string</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="n">VariableDefinition</span><span class="w"> </span><span class="n">myVariable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">VariableDefinition</span><span class="p">(</span><span class="n">il</span><span class="p">.</span><span class="n">Import</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="kt">string</span><span class="p">)));</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">il</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Variables</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">myVariable</span><span class="p">);</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="c1">// We can refer to it by its index</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="kt">int</span><span class="w"> </span><span class="n">varIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">il</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Variables</span><span class="p">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldstr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello world&quot;</span><span class="p">);</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Stloc</span><span class="p">,</span><span class="w"> </span><span class="n">varIndex</span><span class="p">);</span>
</code></pre></div>
<p><strong>Methods</strong></p>
<p>Before calling a method, its arguments from left to right must have been loaded to the stack in a bottom-to-top order. If the method is not static, its instance type (<code>this</code>) must also be loaded as the very first argument.</p>
<p>There are two call instructions, <code>Call</code> and <code>Callvirt</code>. The first is used when the method is static or it belongs to a struct since those always have a non-null instance. For every other case the latter should be used.</p>
<p>Static example</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1">// Debug.Log(&quot;Hello world&quot;);</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldstr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello world&quot;</span><span class="p">);</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">Debug</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Call</span><span class="p">,</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">));</span>
</code></pre></div>
<p>Instance example</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1">// We want to call `this.GetHealthAtRatio(0.25f)` from HealthComponent.TakeDamageProcess</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span><span class="w">         </span><span class="c1">// push `this` on the stack</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldc_R4</span><span class="p">,</span><span class="w"> </span><span class="mf">0.25f</span><span class="p">);</span><span class="w">   </span><span class="c1">// push the float argument on the stack</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">HealthComponent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Callvirt</span><span class="p">,</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">GetHealthAtRatio</span><span class="p">));</span>
</code></pre></div>
<p>If the method name has overloads, we need to specify exactly which one we want by using <a href="https://risk-of-thunder.github.io/R2Wiki/Mod-Creation/C%23-Programming/Reflection-Crash-Course/">Reflection</a>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1">// We want to add a buff to the attacked body in `TakeDamageProcess`</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">HealthComponent</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldfld</span><span class="p">,</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">HealthComponent</span><span class="p">.</span><span class="n">body</span><span class="p">));</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldsfld</span><span class="p">,</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Buffs</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">RoR2Content</span><span class="p">.</span><span class="n">Buffs</span><span class="p">.</span><span class="n">Weak</span><span class="p">));</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="c1">// CharacterBody.AddBuff has two overloads; one with BuffDef and one with BuffIndex.</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="c1">// Specify which one we want by declaring the argument types in GetMethod.</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="n">MethodInfo</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccessTools</span><span class="p">.</span><span class="n">Method</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">.</span><span class="n">AddBuff</span><span class="p">),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Type</span><span class="p">[]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">BuffDef</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Callvirt</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">);</span>
</code></pre></div>
<p><strong>Properties</strong></p>
<p>Properties are simply methods under the hood with the "get_" and "set_" name prefix respectively. While <code>c.Emit&lt;Type&gt;(OpCodes.Callvirt, "get_" + nameof(Type.propertyName))</code> works, there are also other convenience methods available.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span><span class="w"> </span><span class="c1">// push a CharacterBody instance on the stack</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Callvirt</span><span class="p">,</span><span class="w"> </span><span class="n">AccessTools</span><span class="p">.</span><span class="n">PropertyGetter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">CharacterBody</span><span class="p">.</span><span class="n">footPosition</span><span class="p">)));</span>
</code></pre></div>
<h4 id="conditionals-and-branches">Conditionals and branches</h4>
<p>In CIL there is no concept of curly braces to specify what code belongs in an if-else block, instead the code flow is redirected with instruction jumps. <code>Brtrue</code> and <code>Brfalse</code> jump to the target instruction if the boolean at the top of the stack is true or false respectively, while <code>Br</code> jumps unconditionally.</p>
<p>There is also a family of conditional branches related to comparing two numbers, i.e., <code>Ble</code> ( <em>branch if <strong>less</strong> or <strong>equal</strong></em>), <code>Blt</code> (<em>branch if <strong>less than</strong></em>), <code>Bge</code>, <code>Bgt</code>, <code>Beq</code> (<em>branch if <strong>equal</strong></em>), and <code>Bne</code> (<em>branch if <strong>not equal</strong></em>).</p>
<p>It is simpler to understand how the instruction flow is affected by jumps with an example. Suppose we have the following code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Example</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="p">{</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="n">DoTrue</span><span class="p">();</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="n">DoFalse</span><span class="p">();</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="n">DoAfter</span><span class="p">();</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="p">}</span>
</code></pre></div>
<p>The respective CIL becomes</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>IL_0000: ldarg.1
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>IL_0001: brfalse.s IL_000b
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>IL_0003: ldarg.0
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>IL_0004: call instance void C::DoTrue()
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>IL_0009: br.s IL_0011
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>IL_000b: ldarg.0
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>IL_000c: call instance void C::DoFalse()
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>IL_0011: ldarg.0
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>IL_0012: call instance void C::DoAfter()
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>IL_0017: ret
</code></pre></div>
<p>We start by pushing the boolean to the stack with <code>IL_0000</code>. Then for the majority of the instructions, we see that <code>IL_0003</code>-<code>IL_0004</code> (if true), <code>IL_000b</code>-<code>IL_000c</code> (else), and <code>IL_0011</code>-<code>IL_0017</code> (after any if-else) are pretty much ordered serially. On the other hand <code>IL_0001 brfalse</code> does the opposite check than what our C# version does. The reason for this is that if <code>brfalse</code> is not satisfied, we naturally continue to <code>IL_0003</code>, which is the if-block. We also notice that <code>IL_0009 br</code> that comes after the end of the if-block serves the purpose of skipping any else-block instructions. On the other hand, at the end of the else-block we don't need such a jump because we naturally continue with the next instruction anyway. In a sense the instruction targets for <code>brfalse</code> and <code>br</code> specify which instructions belong to the else-block, while the positioning of <code>brfalse</code> and <code>br</code> themselves specify which instructions belong to the if-block.</p>
<p>If our conditional involves null checking a value, we may also see the presence of <code>dup</code> and <code>pop</code> which duplicate/pop the value at the top of the stack. For example, in <code>CharacterBody.OnInventoryChanged</code> at some point the method executes the following code:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">// For clarity we should view the following line as</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="c1">// if (this.onInventoryChanged != null)</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="c1">// {</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="c1">//     this.onInventoryChanged.Invoke();</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="c1">// }</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="k">this</span><span class="p">.</span><span class="n">onInventoryChanged</span><span class="o">?.</span><span class="n">Invoke</span><span class="p">();</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="n">CharacterBody</span><span class="p">.</span><span class="n">onInventoryChangedGlobal</span><span class="o">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</code></pre></div>
<p>When we look at the CIL for this we see</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>// this.onInventoryChanged?.Invoke();
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>IL_030d: ldarg.0
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>IL_030e: ldfld class [netstandard]System.Action RoR2.CharacterBody::onInventoryChanged
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>IL_0313: dup
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>IL_0314: brtrue.s IL_0319
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>// (no C# code)
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>IL_0316: pop
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>IL_0317: br.s IL_031e
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>IL_0319: callvirt instance void [netstandard]System.Action::Invoke()
<a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
<a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>// CharacterBody.onBodyInventoryChangedGlobal?.Invoke(this);
<a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>IL_031e: ldsfld class [netstandard]System.Action`1&lt;class RoR2.CharacterBody&gt; RoR2.CharacterBody::onBodyInventoryChangedGlobal
<a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>IL_0323: dup
<a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>IL_0324: brtrue.s IL_0329
</code></pre></div>
<p><code>IL_030d</code> and <code>IL_030e</code> push to the stack the value we want to null check. <code>IL_0313: dup</code> duplicates this value so now we have two copies of it sitting on the stack. <code>IL_0314: brtrue</code> consumes the top copy for the null check and we have one more on the stack. If our condition is satisfied, we jump to <code>IL_0319</code> where we consume the second copy from the stack to call our method. Then execution naturally continues with the second line of code. However, if our condition is not satisfied, we want to jump straight to the second line of code, but since the remaining copy of <code>this.onInventoryChanged</code> at the top of the stack has no way to be consumed, we must pop it ourselves.</p>
<p>This <code>dup</code>-<code>pop</code> combo can be quite prevelant in cascading checks, e.g., <code>if (this.body &amp;&amp; this.body.master &amp;&amp; this.body.master.playerCharacterMasterController)</code>.</p>
<h5 id="example-1-put-some-code-in-an-if-block">Example 1: Put some code in an if block</h5>
<p><code>RoR2.Mecanim.ClearLayerWeight.OnStateEnter</code> executes the following code unconditionally.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>// animator.SetLayerWeight(layerIndex2, 0f);
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>IL_0026: ldarg.1
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>IL_0027: ldloc.0
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>IL_0028: ldc.r4 0.0
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>IL_002d: callvirt instance void [UnityEngine.AnimationModule]UnityEngine.Animator::SetLayerWeight(int32, float32)
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>IL_0032: ret
</code></pre></div>
<p>Generally whenever a layer index is involved in an animation, the code should check <code>if (layerIndex &gt;= 0)</code> first to prevent the animator method from printing a warning to the console. To fix the above case ourselves, we need to find the instruction that comes after that method call, then put our cursor back to the beginning of the animator line and emit a conditional check. If our check is not satisfied, we jump to the next instruction we have cached.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kt">var</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ILCursor</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kt">int</span><span class="w"> </span><span class="n">localVarIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="n">MoveType</span><span class="p">.</span><span class="n">After</span><span class="p">,</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdarg</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdloc</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">localVarIndex</span><span class="p">),</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchLdcR4</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">_</span><span class="p">),</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="o">&lt;</span><span class="n">Animator</span><span class="o">&gt;</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">Animator</span><span class="p">.</span><span class="n">SetLayerWeight</span><span class="p">))))</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="p">{</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="n">Instruction</span><span class="w"> </span><span class="n">nextInstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Next</span><span class="p">;</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">    </span><span class="c1">// Put our cursor back before the first matched instruction.</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">    </span><span class="c1">// This is safe as long as we don&#39;t go further back than that.</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">    </span><span class="c1">// If we wanted to surround multiple lines of code in the if block,</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">    </span><span class="c1">// we&#39;d have to use `c.TryGotoPrev` to go back to the first line since</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">    </span><span class="c1">// here we only matched the last line to cache the next instruction.</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Index</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldloc</span><span class="p">,</span><span class="w"> </span><span class="n">localVarIndex</span><span class="p">);</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldc_I4_0</span><span class="p">);</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">    </span><span class="c1">// We branch for the negation of our intended check:</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">    </span><span class="c1">// NOT &quot;greater or equal&quot; is equivalent to &quot;less than&quot;</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Blt_S</span><span class="p">,</span><span class="w"> </span><span class="n">nextInstr</span><span class="p">);</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="p">}</span>
</code></pre></div>
<h5 id="example-2-null-check-a-statement-to-patch-nre-errors">Example 2: Null check a statement to patch NRE errors</h5>
<p>Assuming we have a method call or field access whose type instance could be null. This would be something like <code>variable.MyMethod()</code> and we'd want to convert it to <code>variable?.MyMethod()</code>. The original instructions would be something like</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>IL_0000 ldloc      
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>IL_0001 callvirt
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>IL_0002 somethingelse
</code></pre></div>
<p>In order to null check this, we need to insert the following instructions between <code>ldloc</code> and <code>callvirt</code> as explained in the <a href="./#conditionals-and-branches">Conditionals and branches</a> section.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>dup
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>brtrue IL_0001
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>pop
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>br IL_0002
</code></pre></div>
<p>An example of this has already been covered <a href="./#4-use-cindex-with-great-care">above</a>.</p>
<h5 id="example-3-add-an-else-to-an-if">Example 3: Add an else to an if</h5>
<p>Sometimes instead of modifying the code of an if-block, you want to extend it by adding an else-block for your own case. Let's assume we have the following code</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">public</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Example</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">flag</span><span class="p">)</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="p">{</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="w">    </span><span class="p">{</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="n">DoTrue</span><span class="p">();</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="n">DoAfter</span><span class="p">();</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="p">}</span>
</code></pre></div>
<p>where its CIL is</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">IL_0000</span><span class="p">:</span><span class="w"> </span><span class="n">ldarg</span><span class="mf">.1</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">IL_0001</span><span class="p">:</span><span class="w"> </span><span class="n">brfalse</span><span class="p">.</span><span class="n">s</span><span class="w"> </span><span class="n">IL_0009</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">IL_0003</span><span class="p">:</span><span class="w"> </span><span class="n">ldarg</span><span class="mf">.0</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="n">IL_0004</span><span class="p">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">C</span><span class="p">::</span><span class="n">DoTrue</span><span class="p">()</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="n">IL_0009</span><span class="p">:</span><span class="w"> </span><span class="n">ldarg</span><span class="mf">.0</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="n">IL_000a</span><span class="p">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="n">C</span><span class="p">::</span><span class="n">DoAfter</span><span class="p">()</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="n">IL_000f</span><span class="p">:</span><span class="w"> </span><span class="n">ret</span>
</code></pre></div>
<p>This is the same example from the <a href="./#conditionals-and-branches">top of the section</a> with missing the else-block. The steps of adding that are</p>
<ol>
<li>Go between the last instruction of the if-block and the first instruction after</li>
<li>Add the <code>br</code> targetting the instruction after</li>
<li>Add the else-block code while caching the first instruction of this block</li>
<li>Go back to the <code>brfalse</code> (if check) and reassign the target to the first instruction of the else-block</li>
</ol>
<p>In code this would be</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="c1">// 1</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoNext</span><span class="p">(</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="n">MoveType</span><span class="p">.</span><span class="n">After</span><span class="p">,</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchCallOrCallvirt</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">DoTrue</span><span class="p">)))</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="p">{</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="n">Log</span><span class="p">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Patch failed&quot;</span><span class="p">);</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="p">}</span><span class="w">    </span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="c1">// 2</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Br</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Next</span><span class="p">);</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="c1">// 3.1 Add the first instruction of the else-block and cache it</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Ldarg_0</span><span class="p">);</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="n">Instruction</span><span class="w"> </span><span class="n">elseInstruction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">.</span><span class="n">Prev</span><span class="p">;</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="c1">// 3.2 Add the remaining instructions of the else-block</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="n">c</span><span class="p">.</span><span class="n">Emit</span><span class="o">&lt;</span><span class="n">C</span><span class="o">&gt;</span><span class="p">(</span><span class="n">OpCodes</span><span class="p">.</span><span class="n">Callvirt</span><span class="p">,</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">DoFalse</span><span class="p">));</span>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="c1">// 4</span>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">TryGotoPrev</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">MatchBrfalse</span><span class="p">(</span><span class="k">out</span><span class="w"> </span><span class="n">_</span><span class="p">))</span>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a><span class="p">{</span>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a><span class="w">    </span><span class="n">c</span><span class="p">.</span><span class="n">Next</span><span class="p">.</span><span class="n">Operand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elseInstruction</span><span class="p">;</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a><span class="p">}</span>
</code></pre></div>
<h2 id="hook-chain">Hook chain</h2>
<p>Unlike On Hooks which are executed every time the hooked method is called, IL Hooks are executed only once when applied.</p>
<p>If multiple mods hook the same method, e.g., <code>A</code> -&gt; <code>B</code> -&gt; <code>C</code>, the hooks are applied in the same order. More specifically</p>
<ul>
<li>when <code>A</code> is registered, <code>A</code> is applied</li>
<li>when <code>B</code> is then registered, we start from a clean state and apply <code>A</code> and then <code>B</code></li>
<li>etc</li>
</ul>
<p>This also means that if some hook logs a message, we may observe it multiple times.</p>
<p>Similarly, if some hook makes bad assumptions and emits invalid code, an error will be logged to the console. If this error is logged multiple times, you need to look for the first instance of it to find the offending hook.</p>
<h2 id="manual-il-hooks">Manual IL Hooks</h2>
<p>Manually applying an IL Hook works exactly in the same way as for <a href="https://risk-of-thunder.github.io/R2Wiki/Mod-Creation/C%23-Programming/Hooking/On-Hook#manual-on-hooks">On Hooks</a>.</p>
<p>The only differences are</p>
<ul>
<li>We use <code>new ILHook()</code> instead of <code>new Hook()</code></li>
<li>The <code>hookDelegate</code> always has the same (and simpler) signature of <code>void HookName(ILContext il)</code></li>
<li>The hook config is <code>ILHookConfig</code> instead of <code>HookConfig</code></li>
</ul>
<h3 id="hooking-a-coroutine-ienumerator">Hooking a coroutine (IEnumerator)</h3>
<p>Let's take <code>RoR2.Console.AwakeCoroutine</code> for example. When we view its IL instructions, we see</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>IL_0000: ldc.i4.0
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>IL_0001: newobj instance void RoR2.Console/&#39;&lt;AwakeCoroutine&gt;d__57&#39;::.ctor(int32)
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>IL_0006: dup
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>IL_0007: ldarg.0
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>IL_0008: stfld class RoR2.Console RoR2.Console/&#39;&lt;AwakeCoroutine&gt;d__57&#39;::&#39;&lt;&gt;4__this&#39;
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>IL_000d: ret
</code></pre></div>
<p>This does not correspond at all to the decompiled C#. This is because IEnumerators are treated as state machines. If we look at the members of <code>RoR2.Console</code>, we'll see a weird named class called <code>&lt;AwakeCoroutine&gt;d__57</code> which contains the functionality for advancing the state machine. We are mainly interested in its <code>MoveNext</code> method which actually contains the code we see for the decompiled C#. All the original <code>Console.AwakeCoroutine</code> does under the hood is set up the state machine as witnessed by its IL instructions.</p>
<p>So in order to modify the coroutine, we actually need to create an IL Hook for that special MoveNext method. We start by defining a helper method</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">ILHook</span><span class="w"> </span><span class="nf">CreateIEnumeratorILHook</span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">methodName</span><span class="p">,</span><span class="w"> </span><span class="n">ILContext</span><span class="p">.</span><span class="n">Manipulator</span><span class="w"> </span><span class="n">manipulator</span><span class="p">)</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="p">{</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">allFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">BindingFlags</span><span class="p">)(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">moveNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type</span><span class="p">.</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="w">        </span><span class="n">GetNestedTypes</span><span class="p">(</span><span class="n">allFlags</span><span class="p">).</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">        </span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">methodName</span><span class="p">)).</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">        </span><span class="n">GetMethods</span><span class="p">(</span><span class="n">allFlags</span><span class="p">).</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="w">        </span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="s">&quot;MoveNext&quot;</span><span class="p">));</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">ILHook</span><span class="p">(</span><span class="n">moveNext</span><span class="p">,</span><span class="w"> </span><span class="n">manipulator</span><span class="p">);</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="p">}</span>
</code></pre></div>
<p>which can then be used like</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">CreateIEnumeratorILHook</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RoR2</span><span class="p">.</span><span class="n">Console</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">RoR2</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="n">AwakeCoroutine</span><span class="p">),</span><span class="w"> </span><span class="n">hookDelegate</span><span class="p">);</span>
</code></pre></div>
<p>MonoMod.Utils provides a very handy extension for <a href="https://github.com/MonoMod/MonoMod/blob/master/MonoMod.Utils/Extensions.Utils.cs#L237"><code>MethodInfo</code></a> which can also achieve the same thing.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">MethodInfo</span><span class="w"> </span><span class="n">targetMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AccessTools</span><span class="p">.</span><span class="n">Method</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">RoR2</span><span class="p">.</span><span class="n">Console</span><span class="p">),</span><span class="w"> </span><span class="k">nameof</span><span class="p">(</span><span class="n">RoR2</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="n">AwakeCoroutine</span><span class="p">));</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="k">new</span><span class="w"> </span><span class="nf">ILHook</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">.</span><span class="n">GetStateMachineTarget</span><span class="p">(),</span><span class="w"> </span><span class="n">hookDelegate</span><span class="p">);</span>
</code></pre></div>
<h2 id="misc-notes">Misc notes</h2>
<ul>
<li>Output the result IL of a delegate
  <div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>var dmd = new DynamicMethodDefinition(method.Method);
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>var il = dmd.GetILProcessor().Body.Instructions.ToList();
</code></pre></div>
  With thanks to Viseyth for finding the solution to this problem.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.indexes", "navigation.top", "content.action.edit"], "search": "../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>